<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>IT Stock & Expense Dashboard — Sample</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    :root {
      --bg: #0f1115;         /* page bg */
      --panel: #151922;      /* panels */
      --panel-2: #1a2030;    /* alt panels */
      --text: #e6e8ee;       /* primary text */
      --muted: #98a2b3;      /* muted text */
      --brand: #6ea8fe;      /* accent */
      --brand-2: #a78bfa;    /* accent 2 */
      --ok: #22c55e;         /* green */
      --warn: #f59e0b;       /* amber */
      --danger: #ef4444;     /* red */
      --chip: #243047;       /* chip bg */
      --border: #273047;     /* soft border */
    }
    * { box-sizing: border-box; }
    html, body { margin:0; padding:0; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background: var(--bg); color: var(--text);} 
    .container { max-width: 1280px; margin: 0 auto; padding: 20px; }
    h1 { font-size: 24px; margin: 8px 0 16px; font-weight: 800; letter-spacing: 0.2px; }
    .sub { color: var(--muted); font-size: 13px; }
    .row { display: grid; gap: 16px; }
    .grid-2 { grid-template-columns: repeat(2, minmax(0,1fr)); }
    .grid-3 { grid-template-columns: repeat(3, minmax(0,1fr)); }
    .grid-4 { grid-template-columns: repeat(4, minmax(0,1fr)); }
    .panel { background: linear-gradient(180deg, var(--panel), var(--panel-2)); border: 1px solid var(--border); border-radius: 14px; padding: 16px; }
    .panel h2 { font-size: 14px; text-transform: uppercase; letter-spacing: 0.12em; color: var(--muted); margin: 0 0 10px; }
    .controls { display: grid; grid-template-columns: 1.3fr 1fr 1fr 1fr 1fr; gap: 12px; align-items: end; }
    label { font-size: 12px; color: var(--muted); display:block; margin-bottom: 6px; }
    select, input[type="date"], input[type="number"], input[type="text"] { width:100%; padding:10px 12px; border-radius:10px; border:1px solid var(--border); background:#0c0f16; color:var(--text); }
    .chips { display:flex; flex-wrap: wrap; gap:8px; }
    .chip { background: var(--chip); border:1px solid var(--border); padding:6px 10px; border-radius:999px; font-size:12px; cursor:pointer; user-select:none; }
    .chip.active { outline: 2px solid var(--brand); }
    .btn { background: linear-gradient(180deg, #1c2538, #1b2340); color:#eaf1ff; border:1px solid var(--border); border-radius: 10px; padding:10px 14px; cursor:pointer; font-weight:600; }
    .btn:active { transform: translateY(1px); }
    .kpis { display:grid; grid-template-columns: repeat(6, minmax(0,1fr)); gap:12px; }
    .kpi { background: linear-gradient(180deg, #131826, #0d1422); border:1px solid var(--border); border-radius:14px; padding:14px; }
    .kpi .label { color: var(--muted); font-size:12px; }
    .kpi .value { font-size:20px; font-weight:800; margin-top:6px; }
    .kpi .delta { font-size:12px; margin-top:4px; }
    .delta.up { color: var(--ok);} .delta.down { color: var(--danger);} .delta.flat { color: var(--muted);} 
    .charts { display:grid; grid-template-columns: 1.5fr 1fr; gap: 12px; }
    .table-wrap { overflow:auto; border-radius: 12px; border:1px solid var(--border); }
    table { width:100%; border-collapse: collapse; }
    th, td { padding:10px 12px; border-bottom:1px solid var(--border); white-space: nowrap; }
    th { text-align:left; font-size:12px; color:var(--muted); cursor:pointer; position: sticky; top: 0; background: #121725; }
    tr:hover td { background: rgba(255,255,255,0.02);} 
    .legend { font-size:12px; color: var(--muted); }
    .pill { padding:2px 8px; border-radius:999px; border:1px solid var(--border); background:#0e1423; font-size:11px; }
    .footer { margin-top: 18px; color: var(--muted); font-size:12px; text-align:center; }
    .thresholds { display:grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap: 12px; }
    .threshold-card { border:1px solid var(--border); background: #111729; border-radius: 12px; padding: 12px; }
    .status-ok { color: var(--ok); }
    .status-warn { color: var(--warn); }
    .status-danger { color: var(--danger); }
    .flex { display:flex; gap: 8px; align-items:center; }
    .justify-between { justify-content: space-between; }
    .nowrap { white-space: nowrap; }
    @media (max-width: 1100px) { .controls { grid-template-columns: 1fr; } .kpis{ grid-template-columns: repeat(2, 1fr);} .charts { grid-template-columns: 1fr; } .thresholds{ grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <div class="container">
    <div class="row">
      <div>
        <div class="sub">Shiploads — Internal Pilot (Sample Data)</div>
        <h1>IT Stock & Expense Dashboard</h1>
      </div>
    </div>

    <!-- Filters -->
    <div class="panel" id="filters">
      <h2>Filters</h2>
      <div class="controls">
        <div>
          <label for="storeSelect">Store</label>
          <select id="storeSelect">
            <option value="ALL">All Stores</option>
          </select>
        </div>
        <div>
          <label>Date From</label>
          <input type="date" id="dateFrom">
        </div>
        <div>
          <label>Date To</label>
          <input type="date" id="dateTo">
        </div>
        <div>
          <label>Movement</label>
          <div class="chips" id="movementChips">
            <div class="chip active" data-mv="ALL">All</div>
            <div class="chip" data-mv="Out">Out</div>
            <div class="chip" data-mv="In">In</div>
          </div>
        </div>
        <div>
          <label>Quick Ranges</label>
          <div class="chips" id="quickRanges">
            <div class="chip" data-range="30">Last 30d</div>
            <div class="chip" data-range="90">Last 90d</div>
            <div class="chip" data-range="180">Last 180d</div>
          </div>
        </div>
      </div>

      <div class="row" style="margin-top:12px; grid-template-columns: 1fr 1fr 1fr 1fr;">
        <div>
          <label>Reason</label>
          <div class="chips" id="reasonChips"></div>
        </div>
        <div>
          <label>Item Type</label>
          <div class="chips" id="typeChips"></div>
        </div>
        <div>
          <label>Cost per Item (AUD)</label>
          <div class="flex">
            <input type="number" id="minCost" placeholder="Min" step="1" min="0">
            <input type="number" id="maxCost" placeholder="Max" step="1" min="0">
          </div>
        </div>
        <div style="align-self:end; text-align:right;">
          <button class="btn" id="resetBtn">Reset Filters</button>
        </div>
      </div>
    </div>

    <!-- KPIs -->
    <div class="kpis" id="kpis">
      <div class="kpi"><div class="label">Items Issued</div><div class="value" id="kpiIssued">—</div><div class="delta" id="kpiIssuedDelta">&nbsp;</div></div>
      <div class="kpi"><div class="label">Items Received</div><div class="value" id="kpiReceived">—</div><div class="delta" id="kpiReceivedDelta">&nbsp;</div></div>
      <div class="kpi"><div class="label">Net Stock Change</div><div class="value" id="kpiNet">—</div><div class="delta" id="kpiNetNote">&nbsp;</div></div>
      <div class="kpi"><div class="label">Total Expense (Out)</div><div class="value" id="kpiExpense">—</div><div class="delta" id="kpiExpenseDelta">&nbsp;</div></div>
      <div class="kpi"><div class="label">Avg Cost / Issue</div><div class="value" id="kpiAvgCost">—</div><div class="delta" id="kpiAvgNote">&nbsp;</div></div>
      <div class="kpi"><div class="label">Unique Items</div><div class="value" id="kpiUnique">—</div><div class="delta" id="kpiUniqueNote">&nbsp;</div></div>
    </div>

    <!-- Charts -->
    <div class="charts" style="margin-top:12px;">
      <div class="panel">
        <h2>Usage Over Time (Issued vs Received)</h2>
        <canvas id="lineChart" height="140"></canvas>
        <div class="legend">Grouped by month; filtered view.</div>
      </div>
      <div class="panel">
        <h2>Expense by Item Type (Out)</h2>
        <canvas id="barChart" height="140"></canvas>
      </div>
    </div>

    <div class="charts" style="margin-top:12px;">
      <div class="panel">
        <h2>Replacement Reasons (Out)</h2>
        <canvas id="donutChart" height="160"></canvas>
      </div>
      <div class="panel">
        <h2>Threshold Watchlist</h2>
        <div class="thresholds" id="thresholds"></div>
      </div>
    </div>

    <!-- Table -->
    <div class="panel" style="margin-top:12px;">
      <h2>Transactions</h2>
      <div class="table-wrap">
        <table id="txTable">
          <thead>
            <tr>
              <th data-sort="date">Date</th>
              <th data-sort="store">Store</th>
              <th data-sort="movement">Move</th>
              <th data-sort="reason">Reason</th>
              <th data-sort="type">Item Type</th>
              <th>Item</th>
              <th data-sort="qty" class="nowrap">Qty</th>
              <th data-sort="cost" class="nowrap">Cost/Item</th>
              <th data-sort="total" class="nowrap">Total Cost</th>
              <th>Notes</th>
              <th>Record ID</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div class="footer">Sample dashboard for pilot planning • Charts and numbers are based on mocked data • © Shiploads (internal)</div>
  </div>

<script>
/**********************
 * 1) MOCK DATA
 **********************/
const STORES = [
  "Glenorchy", "Hobart CBD", "Launceston", "Devonport", "Burnie", "Kingston", "Rosny", "New Town", "Cambridge", "Ulverstone", "Sorell", "Huonville"
];

const ITEM_TYPES = ["Printer","Scanner","Computer","Keyboard","Mouse","EDA Scanner","Monitor","Cable/s","Phone / Cordless","Webcam"];

const REASONS = [
  "Upgrade/Replacement", "New Install", "Received From Supplier", "Returned From Store", "Other"
];

// Helper to random integer
const R = (min, max)=> Math.floor(Math.random()*(max-min+1))+min;

// Generate 10 months of data ending this month
const today = new Date();
const monthsBack = 10;
const mock = [];
let idCounter = 1;

function addTx(dt, store, move, reason, type, item, qty, cost, notes=""){
  mock.push({
    id: `IT-${dt.toISOString().slice(0,10).replace(/-/g,"")}-${String(idCounter++).padStart(4,'0')}`,
    date: dt.toISOString().slice(0,10),
    store, movement: move, reason, type, item,
    qty, cost, total: +(qty*cost).toFixed(2),
    notes
  });
}

// Seed stock movements
for (let m=monthsBack; m>=0; m--) {
  const base = new Date(today.getFullYear(), today.getMonth()-m, 1);
  // Random received shipments into office
  const receipts = R(2,4);
  for(let i=0;i<receipts;i++){
    const dt = new Date(base.getFullYear(), base.getMonth(), R(1,28));
    const type = ITEM_TYPES[R(0, ITEM_TYPES.length-1)];
    addTx(dt, "Office", "In", "Received From Supplier", type, `${type} Model ${R(100,999)}`, R(3,10), R(80,900), `Supplier: ACME Pty`);
  }
  // Issues to stores
  const issues = R(15,30);
  for(let j=0;j<issues;j++){
    const dt = new Date(base.getFullYear(), base.getMonth(), R(1,28));
    const store = STORES[R(0, STORES.length-1)];
    const type = ITEM_TYPES[R(0, ITEM_TYPES.length-1)];
    const reason = ["Upgrade/Replacement","New Install","Other"][R(0,2)];
    const subNote = reason==="Upgrade/Replacement"? ["Disposed","Damaged","Lost"][R(0,2)] : "";
    addTx(dt, store, "Out", reason, type, `${type} Model ${R(100,999)}`, R(1,3), R(80,900), subNote);
  }
  // Returns from store (some months)
  if (Math.random() < 0.6) {
    const returns = R(2,6);
    for(let k=0;k<returns;k++){
      const dt = new Date(base.getFullYear(), base.getMonth(), R(1,28));
      const store = STORES[R(0, STORES.length-1)];
      const type = ITEM_TYPES[R(0, ITEM_TYPES.length-1)];
      addTx(dt, store, "In", "Returned From Store", type, `${type} Model ${R(100,999)}`, R(1,2), R(80,900), "Working");
    }
  }
}

/**********************
 * 2) FILTER STATE
 **********************/
const state = {
  store: 'ALL',
  dateFrom: null,
  dateTo: null,
  movement: 'ALL',
  reasons: new Set(REASONS),
  types: new Set(ITEM_TYPES),
  minCost: null,
  maxCost: null,
  sort: { key: 'date', dir: 'desc' }
};

/**********************
 * 3) INIT FILTER UI
 **********************/
const storeSel = document.getElementById('storeSelect');
STORES.forEach(s=>{ const o=document.createElement('option'); o.value=s; o.textContent=s; storeSel.appendChild(o); });

const reasonChips = document.getElementById('reasonChips');
REASONS.forEach(r=>{ const el=document.createElement('div'); el.className='chip active'; el.dataset.reason=r; el.textContent=r; reasonChips.appendChild(el); });

const typeChips = document.getElementById('typeChips');
ITEM_TYPES.forEach(t=>{ const el=document.createElement('div'); el.className='chip active'; el.dataset.type=t; el.textContent=t; typeChips.appendChild(el); });

// Movement chips
const mvChips = document.querySelectorAll('#movementChips .chip');

// Quick ranges
const quickRanges = document.querySelectorAll('#quickRanges .chip');

// Inputs
const dateFrom = document.getElementById('dateFrom');
const dateTo = document.getElementById('dateTo');
const minCost = document.getElementById('minCost');
const maxCost = document.getElementById('maxCost');
const resetBtn = document.getElementById('resetBtn');

// Default dates: last 90 days
const defTo = new Date();
const defFrom = new Date(); defFrom.setDate(defFrom.getDate()-90);
const toISO = d => d.toISOString().slice(0,10);

state.dateFrom = toISO(defFrom); state.dateTo = toISO(defTo);

// Set inputs
dateFrom.value = state.dateFrom; dateTo.value = state.dateTo;

/**********************
 * 4) EVENT HANDLERS
 **********************/
storeSel.addEventListener('change', ()=>{ state.store = storeSel.value; renderAll(); });

reasonChips.addEventListener('click', (e)=>{
  if(!e.target.classList.contains('chip')) return;
  const r = e.target.dataset.reason;
  if (state.reasons.has(r)) { state.reasons.delete(r); e.target.classList.remove('active'); }
  else { state.reasons.add(r); e.target.classList.add('active'); }
  renderAll();
});

typeChips.addEventListener('click', (e)=>{
  if(!e.target.classList.contains('chip')) return;
  const t = e.target.dataset.type;
  if (state.types.has(t)) { state.types.delete(t); e.target.classList.remove('active'); }
  else { state.types.add(t); e.target.classList.add('active'); }
  renderAll();
});

mvChips.forEach(c=> c.addEventListener('click', ()=>{
  mvChips.forEach(x=>x.classList.remove('active'));
  c.classList.add('active');
  state.movement = c.dataset.mv;
  renderAll();
}));

quickRanges.forEach(c=> c.addEventListener('click', ()=>{
  const days = +c.dataset.range;
  const to = new Date(); const from = new Date(); from.setDate(from.getDate()-days);
  state.dateFrom = toISO(from); state.dateTo = toISO(to);
  dateFrom.value = state.dateFrom; dateTo.value = state.dateTo;
  renderAll();
}));

[dateFrom, dateTo, minCost, maxCost].forEach(inp=> inp.addEventListener('input', ()=>{
  state.dateFrom = dateFrom.value || null; state.dateTo = dateTo.value || null;
  state.minCost = minCost.value? +minCost.value : null;
  state.maxCost = maxCost.value? +maxCost.value : null;
  renderAll();
}));

resetBtn.addEventListener('click', ()=>{
  state.store = 'ALL'; storeSel.value = 'ALL';
  state.dateFrom = toISO(defFrom); state.dateTo = toISO(defTo); dateFrom.value = state.dateFrom; dateTo.value = state.dateTo;
  state.movement = 'ALL'; mvChips.forEach(x=>x.classList.remove('active')); mvChips[0].classList.add('active');
  state.reasons = new Set(REASONS); reasonChips.querySelectorAll('.chip').forEach(c=>c.classList.add('active'));
  state.types = new Set(ITEM_TYPES); typeChips.querySelectorAll('.chip').forEach(c=>c.classList.add('active'));
  state.minCost = null; state.maxCost = null; minCost.value=''; maxCost.value='';
  renderAll();
});

/**********************
 * 5) FILTER + COMPUTE
 **********************/
function withinDate(d, from, to){
  if (from && d < from) return false; if (to && d > to) return false; return true;
}

function getFiltered(){
  return mock.filter(x=>{
    if (state.store !== 'ALL' && x.store !== state.store) return false;
    if (!withinDate(x.date, state.dateFrom, state.dateTo)) return false;
    if (state.movement !== 'ALL' && x.movement !== state.movement) return false;
    if (!state.reasons.has(x.reason)) return false;
    if (!state.types.has(x.type)) return false;
    if (state.minCost!=null && x.cost < state.minCost) return false;
    if (state.maxCost!=null && x.cost > state.maxCost) return false;
    return true;
  });
}

function groupByMonth(rows){
  const map = new Map();
  rows.forEach(r=>{
    const key = r.date.slice(0,7); // YYYY-MM
    if(!map.has(key)) map.set(key, {In:0, Out:0});
    map.get(key)[r.movement] += r.qty;
  });
  return Array.from(map.entries()).sort((a,b)=> a[0].localeCompare(b[0]));
}

function sumExpenseOut(rows){
  return rows.filter(r=>r.movement==='Out').reduce((s,r)=> s+r.total, 0);
}

function avgCostPerIssue(rows){
  const outs = rows.filter(r=>r.movement==='Out');
  const items = outs.reduce((s,r)=> s+r.qty, 0);
  const total = outs.reduce((s,r)=> s+r.total, 0);
  return items? (total/items) : 0;
}

function uniqueItems(rows){
  return new Set(rows.map(r=> r.item)).size;
}

/**********************
 * 6) RENDERERS
 **********************/
const elKpiIssued = document.getElementById('kpiIssued');
const elKpiReceived = document.getElementById('kpiReceived');
const elKpiNet = document.getElementById('kpiNet');
const elKpiExpense = document.getElementById('kpiExpense');
const elKpiAvgCost = document.getElementById('kpiAvgCost');
const elKpiUnique = document.getElementById('kpiUnique');

function formatAUD(n){ return new Intl.NumberFormat('en-AU',{ style:'currency', currency:'AUD'}).format(n); }

function renderKPIs(rows){
  const issued = rows.filter(r=> r.movement==='Out').reduce((s,r)=> s+r.qty, 0);
  const received = rows.filter(r=> r.movement==='In').reduce((s,r)=> s+r.qty, 0);
  const net = received - issued;
  elKpiIssued.textContent = issued.toLocaleString();
  elKpiReceived.textContent = received.toLocaleString();
  elKpiNet.textContent = (net>=0? '+':'') + net.toLocaleString();
  const expense = sumExpenseOut(rows);
  elKpiExpense.textContent = formatAUD(expense);
  elKpiAvgCost.textContent = formatAUD(avgCostPerIssue(rows));
  elKpiUnique.textContent = uniqueItems(rows).toLocaleString();
}

// Charts
let lineChart, barChart, donutChart;

function ensureChart(ctx, type, data, options){
  if (ctx._chart) { ctx._chart.destroy(); }
  ctx._chart = new Chart(ctx, { type, data, options });
  return ctx._chart;
}

function renderLine(rows){
  const byMonth = groupByMonth(rows);
  const labels = byMonth.map(([k])=> k);
  const out = byMonth.map(([,v])=> v.Out);
  const inn = byMonth.map(([,v])=> v.In);
  const ctx = document.getElementById('lineChart');
  ensureChart(ctx, 'line', {
    labels,
    datasets: [
      { label: 'Issued (Out)', data: out, tension: .3 },
      { label: 'Received (In)', data: inn, tension: .3 }
    ]
  }, { responsive: true, plugins: { legend: { labels: { color: '#cbd5e1' } } }, scales: { x: { ticks:{ color:'#cbd5e1' }}, y:{ ticks:{ color:'#cbd5e1' }}}});
}

function renderBar(rows){
  const map = new Map();
  rows.filter(r=>r.movement==='Out').forEach(r=>{
    map.set(r.type, (map.get(r.type)||0)+r.total);
  });
  const labels = Array.from(map.keys());
  const data = Array.from(map.values());
  const ctx = document.getElementById('barChart');
  ensureChart(ctx, 'bar', {
    labels,
    datasets: [{ label: 'Expense (AUD)', data }]
  }, { responsive:true, plugins:{ legend:{ labels:{ color:'#cbd5e1' } } }, scales:{ x:{ ticks:{ color:'#cbd5e1' }}, y:{ ticks:{ color:'#cbd5e1' }}}});
}

function renderDonut(rows){
  const map = new Map();
  rows.filter(r=>r.movement==='Out').forEach(r=>{
    map.set(r.reason, (map.get(r.reason)||0)+r.qty);
  });
  const labels = Array.from(map.keys());
  const data = Array.from(map.values());
  const ctx = document.getElementById('donutChart');
  ensureChart(ctx, 'doughnut', {
    labels,
    datasets: [{ data }]
  }, { plugins:{ legend:{ position:'bottom', labels:{ color:'#cbd5e1' } } } });
}

function renderTable(rows){
  const tbody = document.querySelector('#txTable tbody');
  tbody.innerHTML = '';
  // sort
  const sorted = rows.slice().sort((a,b)=>{
    const k = state.sort.key; const dir = state.sort.dir==='asc'?1:-1;
    let va=a[k], vb=b[k];
    if (k==='date') { va = a.date; vb = b.date; }
    if (k==='qty' || k==='cost' || k==='total') { va = +a[k]; vb = +b[k]; }
    return (va>vb?1:va<vb?-1:0)*dir;
  });

  for(const r of sorted){
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${r.date}</td>
      <td>${r.store}</td>
      <td><span class="pill">${r.movement}</span></td>
      <td>${r.reason}</td>
      <td>${r.type}</td>
      <td>${r.item}</td>
      <td class="nowrap">${r.qty}</td>
      <td class="nowrap">${formatAUD(r.cost)}</td>
      <td class="nowrap">${formatAUD(r.total)}</td>
      <td>${r.notes||''}</td>
      <td>${r.id}</td>
    `;
    tbody.appendChild(tr);
  }
}

// Sort handlers
Array.from(document.querySelectorAll('#txTable th[data-sort]')).forEach(th=>{
  th.addEventListener('click', ()=>{
    const key = th.dataset.sort;
    state.sort = { key, dir: (state.sort.key===key && state.sort.dir==='asc')?'desc':'asc' };
    renderTable(getFiltered());
  });
});

function monthKey(d){ return d.slice(0,7); }

function renderThresholds(rows){
  // Compute last 6 months usage per item type (Out only)
  const cutoff = new Date(); cutoff.setMonth(cutoff.getMonth()-6); const cutoffISO = toISO(cutoff);
  const last6 = rows.filter(r=> r.date >= cutoffISO);
  const usage = new Map(); // type -> qtyOut
  last6.filter(r=>r.movement==='Out').forEach(r=>{
    usage.set(r.type, (usage.get(r.type)||0)+r.qty);
  });
  // Mock on-hand stock: derive from all-time mock data
  const onhand = new Map(); // type -> qty
  mock.forEach(r=>{
    const delta = r.movement==='In'? r.qty : -r.qty;
    onhand.set(r.type, (onhand.get(r.type)||0)+delta);
  });
  const wrap = document.getElementById('thresholds');
  wrap.innerHTML='';
  const cards = [];
  for(const t of ITEM_TYPES){
    const used6 = usage.get(t)||0; const avgMonthly = used6/6;
    const leadTime = 1; // month (sample)
    const safety = Math.ceil(avgMonthly*0.5);
    const reorderPoint = Math.ceil(avgMonthly*leadTime + safety);
    const stock = onhand.get(t)||0;
    let status = 'ok', msg = 'Healthy';
    if (stock <= reorderPoint) { status = 'warn'; msg = 'At/Below Reorder Point'; }
    if (stock <= Math.max(1, Math.ceil(avgMonthly*0.25))) { status = 'danger'; msg = 'Critically Low'; }
    cards.push({t, stock, avgMonthly, reorderPoint, status, msg});
  }
  // Render top 6 by risk
  cards.sort((a,b)=> (
    (a.status==='danger'?2:a.status==='warn'?1:0) - (b.status==='danger'?2:b.status==='warn'?1:0)
  ) || (a.stock - b.stock));
  cards.slice(0,6).forEach(c=>{
    const div = document.createElement('div');
    const cls = c.status==='danger'?'status-danger':(c.status==='warn'?'status-warn':'status-ok');
    div.className = 'threshold-card';
    div.innerHTML = `
      <div class="flex justify-between"><strong>${c.t}</strong><span class="pill ${cls}">${c.msg}</span></div>
      <div class="row grid-3" style="margin-top:8px;">
        <div><div class="label">On Hand</div><div class="value">${c.stock}</div></div>
        <div><div class="label">Avg Monthly Use (6m)</div><div class="value">${c.avgMonthly.toFixed(1)}</div></div>
        <div><div class="label">Reorder Point</div><div class="value">${c.reorderPoint}</div></div>
      </div>
    `;
    wrap.appendChild(div);
  });
}

/**********************
 * 7) MAIN RENDER
 **********************/
function renderAll(){
  const rows = getFiltered();
  renderKPIs(rows);
  renderLine(rows);
  renderBar(rows);
  renderDonut(rows);
  renderTable(rows);
  renderThresholds(rows);
}

renderAll();
</script>
</body>
</html>
